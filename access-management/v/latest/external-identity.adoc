= External Identity
:keywords: anypoint platform, permissions, configuring, pingfederate, saml

Setting up _external identity_ means that you configure an identity provider (IdP) to authenticate an acting agent (either an user, a client, or both) and then assert to Anypoint Platform that said agent has been validated by it and should be trusted.

This means that you can set up:

* External identities for user management using SAML 2.0
* External identities for client management using OAuth 2.0
* External identities for both user and client management

[NOTE]
====
In order to set external identities, you need to own the proper entitlements. If you don't have the _External Identity_ option in your _Access Management_ menu please contact your sales representative or customer success manager.
====

== User Management

The Anypoint Platform can be integrated with your organization's external federated identity system. +
Opting to use federated identity management for the Anypoint Platform gives your users single sign-on access (SSO).

If all you need is the ability to implement *user management*, you need to select a working <<Saml 2.0,SAML 2.0 compliant Identity provider>> (if you don´t have one) and follow the <<Instructions for SAML Configuration,SAML configuration instructions>>.

=== Saml 2.0 Identity Providers

The Anypoint Platform supports SAML 2.0 compliant identity management providers for user management and SSO, the following IdPs have been successfully tested as working with Anypoint Platform:

* link:https://www.pingidentity.com/en/products/pingfederate.html[Ping Federate]
* link:https://forgerock.org/openam/[OpenAM]
* link:https://www.okta.com/[Okta]
* link:https://shibboleth.net/[Shibboleth]
* link:https://msdn.microsoft.com/en-us/library/bb897402.aspx?f=255&MSPPError=-2147217396[ADFS]
* link:https://www.onelogin.com/[onelogin]
* link:http://www.ca.com/us/products/ca-single-sign-on.html[CA SiteMinder]

For these providers, the 'Assertion Consumer Service' or 'SAML Assertion URL' is `https://anypoint.mulesoft.com/accounts/login/receive-id` and the 'entityID' or 'Audience URL' is any string value that identifies your organization. By convention it is <organizationDomain>.anypoint.mulesoft.com, but any value is acceptable.


If you choose to configure either OpenAM or Ping Federate and you wish to implement both *User Management* as well as *Client Management* (to facilitate OAuth security for APIs) then, based on the IdP you want to configure, follow the  <<openam-client,openAM for client management instructions>>  or the <<pingfederate-client,PingFederate for client management instructions>> respectively.

[NOTE]
--
The list of IdPs described above shows providers that have been succesfully tested with Anypoint Platform. However, any provider compliant with SAML 2.0 should work following the <<Instructions for SAML Configuration, instructions below>>.
--

==== Instructions for SAML Configuration

The instructions in this document allow you to configure your Anypoint Platform organization with any of the supported SAML 2.0 providers for SSO.

To configure federated identity:

. Configure your SAML provider to set up your Anypoint Platform organization as your audience.
. Set the *Assertion Consumer Service* to send an HTTP POST request to the following address: `https://anypoint.mulesoft.com/accounts/login/receive-id`
. Log in with an administrator account into your Anypoint organization, click on the gear icon in the Nav bar which will take you to the Access Manager user interface , and select *External Identity*. If you haven't set anything yet, you should see a screen like this:
+
image:new-saml.png[new saml]

. Click the link for "If you would like to configure single sign on with a SAML 2.0 provider you can get started *here*" and then provide the necessary data in the SAML 2.0 form to set up your Anypoint organization for SSO:
+
image:federated-form.png[federated identity form]
+
You must provide the following information in the form:

[cols="20a,80a",options="header"]
|===
|Field |Description
|Issuer |ID of the identity provider instance that sends SAML assertions.
|Public Key |Public key provided by the identity provider, used to sign the SAML assertion.
|Audience |ID of the Service Provider (In this case, the Anypoint Platform). This is a string value that identifies your organization. By convention it is <organizationDomain>.anypoint.mulesoft.com, but any value is acceptable.
|Username Attribute |Field name in the SAML repository that maps to username. By default, the 'NameID' attribute in the SAML assertion is used.
|First Name Attribute |Field name in the SAML repository that maps to First Name.
|Last Name Attribute |Field name in the SAML repository that maps to Last Name.
|Email Attribute |Field name in the SAML repository that maps to Email.
|Group Attribute |Field name in the SAML repository that maps to Group.
|Sign On URL |URL where users must sign in.
|Sign Out URL |URL to redirect sign out requests, so users both sign out of the Anypoint Platform and have their SAML user's status set to signed out.
|===

=== Federated Organizations - Map Users to Anypoint Platform Roles

As of November 2014, Anypoint Platform provides a feature to help you map users in a federated organization's LDAP group to an Anypoint link:/access-management/roles.adoc[Role].

This requires that your Anypoint Platform organization utilizes an external identity provider such as link:https://www.pingidentity.com/en/products/pingfederate.html[PingFederate].

This feature enables users in an organization to sign in to Anypoint Platform using the same organizational credentials and access permissions that an organization maintains using LDAP. +
This ensures credential security and maintains organizational roles for accessing privileged information.

To support this feature you first need to configure an external identity following any of the methods described above, and then follow the two steps described below:

===== Verify SAML Information

The SAML assertion is an XML file that is issued by the external identity provider.

Log into Anypoint Platform and click the *External Identity* tab to verify your organization's Identity management information.

image:APExtIdentityTab.png[APExtIdentityTab.png]

Verify that the **group_attribute **value is set to the correct attribute name. In the example above, the attribute is named *memberOf*. You can see a sample SAML assertion with that attribute below:

[source,xml,linenums]
----
<saml:Attribute NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic" Name="memberOf">
  <saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">cn=jira-users,ou=groups,dc=muleforge,dc=org</saml:AttributeValue>
  <saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">cn=confluence-users,ou=groups,dc=muleforge,dc=org</saml:AttributeValue>
  <saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">cn=mule-community,ou=groups,dc=muleforge,dc=org</saml:AttributeValue>
  <saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:string">cn=SR-User,ou=Groups,dc=muleforge,dc=org</saml:AttributeValue>
</saml:Attribute>
----

All other information on the tab is provided when registering an organization to use Anypoint Platform. If any information needs to be changed, log into the  link:https://www.mulesoft.com/support-login[MuleSoft Support Portal] and submit a request.

===== Configure Roles

To configure a role:

. In Anypoint Platform, click *Roles*. Click *Add role* to create a role for each group of users in your organization.
+
image:RolesAddRole.png[RolesAddRole.png]

. Specify a role name and description. Click *Add role* to add the role:
+
image:APNewRoleJU.png[APNewRoleJU.png] +

. In the *Roles* menu, click the name of the new role:
+
image:APClickRole.png[APClickRole.png] +

.  Click *Set external group mapping*:
+
image:APJUInfo.png[APJUInfo.png] +

. Copy the string from your SAML assertion's AttributeValue to the *External group name* field, for example:
+
SAML AttributeValue:
+
[source,xml,linenums]
----
<saml:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:type="xs:string">cn=jira-users,ou=groups,dc=muleforge,dc=org</saml:AttributeValue>
----

+
Mapping:
+
image:APJUSetExGrpMap.png[APJUSetExGrpMap.png]

. Click *Update*.
. Repeat this process for each role that you would like mapped to an external group.


== Client Management

////
Explain Client MGMT
////

=== OAuth 2.0

////
[enterprise only] (link to the sheet)
////

[[openam-client]]
=== openAM

If you want to use openAM for 'client management' and if you're *not using* Anypoint Platform on premises, you need to request that your account be configured in that way, as you can't set this up manually. +
Work with your MuleSoft account representative to ensure that we are aware of your needs for configuring your organization with PingFederate.

Complete the link:https://docs.google.com/forms/d/1ZvNUWU3u0lzLk6H5R3lKcEN2Dcyg1zekc1HYtYIcZP0/viewform[OpenAM form] and MuleSoft will get back to you within 48 hours with either the completion of the configuration or follow-up questions to complete the configuration.

[NOTE]
====
If you are using Anypoint Platform on premises, you do not need to provide this information to MuleSoft.
====


[[pingfederate-client]]
=== Ping federate

If you want to use Ping Federate for 'client management' and if you're *not using* Anypoint Platform on premises, you need to request that your account be configured in that way, as you can't set this up manually. +
Work with your MuleSoft account representative to ensure that we are aware of your needs for configuring your organization with PingFederate.

Complete the link:https://docs.google.com/a/mulesoft.com/forms/d/16ZQjXcLmuXO8140svkjUxywzkZjv01GTgbf_3kfEebQ/viewform[Ping Federate Form]. After you complete this form, MuleSoft gets back to you within 48 hours with either the completion of the configuration or follow-up questions to complete the configuration.

[NOTE]
====
If you are using Anypoint Platform on premises, you do not need to provide this information to MuleSoft.
====


[NOTE]
Having a single audience (an Anypoint Platform organization) served by multiple issuers (multiple SAML provider instances) is currently not supported.


== Single Log Out

Single log out is important so that a user or user agent can log out of an authenticated environment and ensure that both service providers and identity servers process the log out correctly.

To configure single log out:

. In PingFederate, click the *SP Configuration* for the Anypoint Platform.
. Go to *Browser SSO* and click *Configure Browser SSO*.
. Under *SAML Profiles*, ensure that these are set:
** *IdP-Initiated SSO*
** *IdP-Initiated SLO*
** *SP-Initiated SLO*
. Go to *Protocol Settings* and click *Configure Protocol Settings*.
. Configure a *SLO Service Url* with the following:
** *Binding*: POST
** *Endpoint URL*: Set PARTNER_SP_ID to the correct value: `https://anypoint.mulesoft.com/accounts/logout/receive-id`
+
It's also possible to control where the user is redirected after signing out. Most customers like to redirect the user to a different page so we allow you to configure that in your PingFederate's service provider configuration. You can add a `redirect_uri` query parameter to the SLO Service URL and the Anypoint Platform routes the user there rather than to the Anypoint Platform sign-in page.
+
For example, if you want to route the users back to your signin page, make the URL:
+
[source]
----
https://anypoint.mulesoft.com/accounts/logout/receive-id?redirect_uri=https%3A%2F%2Fanypoint.mulesoft.com%2Faccounts%2Flogin%2Fyour-domain
----
+
If you want to route the users back to your portal page, make the URL:
+
[source]
----
https://anypoint.mulesoft.com/accounts/logout/receive-id?redirect_uri=https%3A%2F%2Fanypoint.mulesoft.com%2Fapiplatform%2Fyour-domain%2F%23%2Fportals
----
+
. Under *Allowable SAML Bindings*, click *Redirect*.
. Under *Encryption Policy*, make certain that nothing is encrypted.
. Save and click *Done* out of *Protocol Settings* and *Browser SSO*.
. When viewing the *SP Configuration* for Anypoint Platform, go to *Credentials*, and click *Configure Credentials*.
. Under *Signature Verification Settings*, click *Manage Signature Verification Settings*. Set the *Trust Model* to *Unanchored*, and import the link:_attachments/anypoint-platform-slo.pem[attached certificate]. Make it the active certificate.


== See Also

* Learn more about link:/access-management/managing-accounts-roles-and-permissions[managing accounts, roles and permissions].
